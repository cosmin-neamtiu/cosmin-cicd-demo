name: CD Dev (Deploy)

on:
  workflow_run:
    workflows: ["CI (Build & Upload)"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy-dev:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    
    # We need to explicitly allow the action to create issues if vulnerabilities are found
    permissions:
      contents: read
      issues: write 

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'eu-central-1' }}

      - name: Download Artifact
        env:
          BUCKET: ${{ vars.ARTIFACTS_BUCKET || secrets.ARTIFACTS_BUCKET }}
          COMMIT_HASH: ${{ github.event.workflow_run.head_sha || github.sha }}
        run: |
          aws s3 cp s3://$BUCKET/builds/$COMMIT_HASH.zip site.zip

      - name: Setup SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY_DEV_B64 }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Deploy to EC2
        env:
          HOST: ${{ secrets.EC2_HOST_DEV }} # Use Secrets!
          USER: "ec2-user"
        run: |
          scp -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 site.zip $USER@$HOST:/tmp/site.zip
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 $USER@$HOST << 'EOF'
            set -e
            sudo mkdir -p /usr/share/nginx/html
            sudo rm -rf /usr/share/nginx/html/*
            sudo unzip -o /tmp/site.zip -d /usr/share/nginx/html
            echo "Deployed via CD" | sudo tee /usr/share/nginx/html/version.txt
            sudo systemctl reload nginx || sudo systemctl restart nginx
          EOF

      # ---------------------------------------------------------
      # VALIDATE STAGE
      # ---------------------------------------------------------

      - name: 1. Functional Health Check
        env:
          HOST: ${{ secrets.EC2_HOST_DEV }}
        run: |
          echo "Waiting for Nginx..."
          sleep 5
          curl --fail "http://$HOST/version.txt"
          echo "âœ… Server is responding."

      - name: 2. DAST Scan (OWASP ZAP)
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: "http://${{ secrets.EC2_HOST_DEV }}"
          fail_action: false # Don't break the build for minor warnings, just report
          cmd_options: '-a'  # Includes alpha passive rules
          artifact_name: 'zap-scan-report'