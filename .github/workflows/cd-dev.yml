name: CD Dev (Deploy)

on:
  workflow_run:
    workflows: ["CI (Build & Upload)"]
    types:
      - completed
  workflow_dispatch: # Allows manual trigger

jobs:
  deploy-dev:
    # Only run if the CI workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'eu-central-1' }}

      - name: Download Artifact from S3
        env:
          BUCKET: ${{ vars.ARTIFACTS_BUCKET }}
          # Use the commit hash that triggered this workflow
          COMMIT_HASH: ${{ github.event.workflow_run.head_sha || github.sha }}
        run: |
          echo "Downloading s3://$BUCKET/builds/$COMMIT_HASH.zip..."
          aws s3 cp s3://$BUCKET/builds/$COMMIT_HASH.zip site.zip

      - name: Setup SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY_DEV_B64 }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Deploy to EC2
        env:
          HOST: ${{ secrets.EC2_HOST_DEV }}
          USER: "ec2-user"
        run: |
          # 1. Upload the zip
          scp -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 site.zip $USER@$HOST:/tmp/site.zip
          
          # 2. Remote commands: Clean, Unzip, Reload Nginx
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 $USER@$HOST << 'EOF'
            set -e
            sudo mkdir -p /usr/share/nginx/html
            sudo rm -rf /usr/share/nginx/html/*
            sudo unzip -o /tmp/site.zip -d /usr/share/nginx/html
            echo "Deployed via CD" | sudo tee /usr/share/nginx/html/version.txt
            sudo systemctl reload nginx || sudo systemctl restart nginx
          EOF

      - name: Health Check
        env:
          HOST: ${{ secrets.EC2_HOST_DEV }}
        run: |
          echo "Checking http://$HOST ..."
          # Retry a few times in case Nginx is restarting
          sleep 5
          curl --fail --max-time 5 "http://$HOST" || exit 1
          echo "âœ… Deployment successful!"