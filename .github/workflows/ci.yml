name: CI (Build & Upload)

on:
  push:
    branches: [ "**" ] # Run CI on ALL branches to test them
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. LINT
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install & Run HTML Validator
        run: |
          npm install -g html-validate
          echo '{ "extends": ["html-validate:recommended"], "rules": { "no-trailing-whitespace": "off" } }' > .htmlvalidate.json
          html-validate "site/**/*.html"

      # 2. SAST
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          hide-progress: false
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

  build-and-upload:
    needs: quality-checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 3. BUILD / COMPILE (Runs on ALL branches)
      # This proves the code "compiles" (zips) successfully
      - name: Create artifact (site.zip)
        run: |
          cd site
          zip -r ../site.zip .
          echo " Build successful (site.zip created)"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'eu-central-1' }}

      # 4. UPLOAD STANDARD (Always use SHA for traceability)
      - name: Upload Build Artifact (SHA)
        if: ${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/') }}
        env:
          BUCKET: ${{ vars.ARTIFACTS_BUCKET || secrets.ARTIFACTS_BUCKET }}
          COMMIT_HASH: ${{ github.sha }}
        run: |
          echo " Uploading build artifact..."
          aws s3 cp site.zip s3://$BUCKET/builds/$COMMIT_HASH.zip

      # 5. UPLOAD RELEASE (Run ONLY on Tags) <-- THIS WAS MISSING
      # This creates the specific file 'releases/v5.0.0.zip' that release.yml looks for.
      - name: Upload Release Artifact (Tag)
        if: startsWith(github.ref, 'refs/tags/')
        env:
          BUCKET: ${{ vars.ARTIFACTS_BUCKET || secrets.ARTIFACTS_BUCKET }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          echo " Tag detected: $TAG_NAME"
          echo " Creating Release copy..."
          aws s3 cp site.zip s3://$BUCKET/releases/$TAG_NAME.zip
          echo " Release artifact created."

      # Optional: Notification for Feature Branches
      - name: Skip Upload Notice
        if: ${{ github.ref != 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/') }}
        run: |
          echo " Skipping S3 Upload."
          echo "Reason: This is a feature branch. We verified the build, but we won't store the artifact."