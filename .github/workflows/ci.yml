name: CI (Build & Upload)
 
on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # JOB 1: QUALITY CHECKS (Lint + SAST)
  quality-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. LINT: Check HTML syntax
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install & Run HTML Validator
        run: |
          npm install -g html-validate
          echo '{ "extends": ["html-validate:recommended"], "rules": { "no-trailing-whitespace": "off" } }' > .htmlvalidate.json
          html-validate "site/**/*.html"

      # 2. SAST: Check for secrets & config issues
      - name: Run Trivy Vulnerability Scanner (SAST)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'             # Scan the file system
          scan-ref: '.'               # Scan the current directory
          hide-progress: false
          format: 'table'             # Output pretty table
          exit-code: '1'              # Fail the job if issues are found
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'   # Only stop for big issues

  # JOB 2: BUILD
  build-and-upload:
    needs: quality-checks  # Runs only if Lint AND SAST pass
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create artifact (site.zip)
        run: |
          cd site
          zip -r ../site.zip .

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'eu-central-1' }}

      - name: Upload to S3
        env:
          BUCKET: ${{ vars.ARTIFACTS_BUCKET || secrets.ARTIFACTS_BUCKET }}
          COMMIT_HASH: ${{ github.sha }}
        run: |
          aws s3 cp site.zip s3://$BUCKET/builds/$COMMIT_HASH.zip
          echo " Uploaded to s3://$BUCKET/builds/$COMMIT_HASH.zip"